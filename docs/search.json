[
  {
    "objectID": "posts/out_of_balance/index.html",
    "href": "posts/out_of_balance/index.html",
    "title": "Out of balance",
    "section": "",
    "text": "Code\nlibrary(tidyverse)\nlibrary(ospowertrader)\nlibrary(lubridate)\nlibrary(timetk)\nlibrary(arrow)"
  },
  {
    "objectID": "posts/out_of_balance/index.html#exploring-the-link-between-imbalance-prices-in-the-apg-control-area-and-terna",
    "href": "posts/out_of_balance/index.html#exploring-the-link-between-imbalance-prices-in-the-apg-control-area-and-terna",
    "title": "Out of balance",
    "section": "Exploring the link between imbalance prices in the APG control area and Terna",
    "text": "Exploring the link between imbalance prices in the APG control area and Terna\n\n\nCode\napg_prices <- arrow::read_parquet(\"./data/apg_imbalance_prices.parquet\")\nterna_prices <- arrow::read_parquet(\"./data/terna_imbalance_prices.parquet\")\n\ncombined_prices <- apg_prices %>% \n  inner_join(terna_prices, by = c(\"df\" = \"reference_date\")) %>% \n  select(df, apg_price = ae_price, terna_price = unbalance_price_EURxMWh) \n\ncombined_prices %>% \n  pivot_longer(-df) %>% \n  timetk::plot_time_series(\n    df, value, name, .smooth = FALSE, .title = \"APG vs Terna (1)\"\n  )\n\n\n\n\n\n\nThis graph shows pretty well the impact of Terna’s participation to the Picasso platform. While large spikes, which were already common in the Austrian Control Area, were unheard of in Italy, after the 19th of July they became relatively common in Italy too.\n\n\nCode\ncombined_prices %>% \n  ggplot(aes(apg_price, terna_price))+\n  stat_binhex(bins = 50)+\n  scale_fill_gradient(low = \"blue\", high = \"red\")+\n  theme_bw()+\n  ggtitle(\"APG vs Terna (2)\")\n\n\n\n\n\nHere we can see there is a lot of covariance for extreme values, notice (!) the difference in scale. APG tends to present much extremer imbalance prices.\n\n\nCode\ncombined_prices %>% \n  filter(abs(apg_price) < 300 & abs(terna_price) < 300) %>% \n  ggplot()+\n  geom_histogram(aes(apg_price), alpha = 0.8, fill = \"red\", bins = 200)+\n  geom_histogram(aes(terna_price), alpha = 0.2, colour = \"lightblue\", bins = 200)+\n  theme_bw()+\n  ggtitle(label = \"APG vs Terna (distribution)\")\n\n\n\n\n\nVery surprising. I have no idea why the distribution is so different.\nUnder normal circumstances/normal price levels for imbalance prices - APG seems to have a much smoother distribution. Terna presents more of a multimodal distribution, peaking around zero and two more peaks - probably values concentrate around the MGP/day-ahead price."
  },
  {
    "objectID": "posts/out_of_balance/index.html#picasso-data",
    "href": "posts/out_of_balance/index.html#picasso-data",
    "title": "Out of balance",
    "section": "Picasso data",
    "text": "Picasso data\nFrom the transnetbw.de website we can download price and volume data for the PICASSO platform. The problem working with Picasso data is the very granular nature of the datasets, prices and volumes are published in 4 seconds intervals. In order to work with the data it is necessary to aggregate to quarthourly granularity (to see what approach is used for aggregation see the code section).\n\n\nCode\nprices <- arrow::open_dataset(\"./data/picasso/prices\") %>% \n  select(dt, terna_pos, terna_neg, apg_pos, apg_neg, qo)\n\nvolumes <- arrow::open_dataset(\"./data/picasso/volumes\") %>% \n  select(dt, terna, apg, qo)\n\n\ndata <- prices %>% \n  left_join(volumes, by = c(\"dt\", \"qo\")) %>% \n  collect()\n\n\n# i made a mistake while downloading \n# i should have parsed the single files to convert to numeric\n# now i have to do it manually\n\n## raw picasso: splice volumes in order to avoid netting of volumes (negative and positive)\npicasso_df <- data %>% \n  mutate(\n    terna_pos = as.numeric(terna_pos), \n    terna_neg = as.numeric(terna_neg), \n    terna = as.numeric(terna),\n    apg = as.numeric(apg),\n    apg_pos = as.numeric(apg_pos),\n    apg_neg = as.numeric(apg_neg)\n    ) %>% \n  mutate(\n    terna_pos_vol = if_else(terna > 0, terna, NA),\n    terna_neg_vol = if_else(terna < 0, terna, NA),\n    apg_pos_vol = if_else(apg > 0, apg, NA),\n    apg_neg_vol = if_else(apg < 0, apg, NA)\n  )\n\n## calculate volume weighted prices\n\n\npicasso_df_aggr <- picasso_df %>% \n  group_by(qo) %>% \n  summarise(\n    terna_vw_price_neg = sum(terna_pos_vol * terna_neg, na.rm = TRUE)/sum(terna_pos_vol, na.rm = TRUE),\n    terna_vw_price_pos = sum(terna_neg_vol * terna_pos, na.rm = TRUE)/sum(terna_neg_vol, na.rm = TRUE),\n    apg_vw_price_pos   = sum(apg_pos_vol * terna_neg, na.rm = TRUE)/sum(apg_pos_vol, na.rm = TRUE),\n    apg_vw_price_neg   = sum(apg_neg_vol * terna_pos, na.rm = TRUE)/sum(apg_neg_vol, na.rm = TRUE),\n    ## calculate total volume called for both zones\n    terna_total_pos_called = sum(terna_pos, na.rm  = TRUE) / n(),\n    terna_total_neg_called = sum(terna_neg, na.rm = TRUE) / n(),\n    apg_total_pos_called   = sum(apg_pos, na.rm = TRUE) / n(),\n    apg_total_neg_called   = sum(apg_neg, na.rm = TRUE) / n()\n  ) %>% \n  ungroup() %>% \n  left_join(combined_prices, by = c(\"qo\" = \"df\"))\n\n\n\n\nCode\n# picasso_df_aggr - complete dataset - picasso and imbalanceprices\n# first let's analyse terna and establish whether picasso prices influence imbalance prices\n\n# prepare terna data\n\nterna <- picasso_df_aggr %>% select(qo, starts_with(\"terna\"))\n\nterna_imbalance_volues <- arrow::read_parquet(file = \"./data/terna_imbalance_volumes.parquet\") %>% \n  select(reference_date, imbalance = zonal_aggregate_unbalance_MWh)\n\nterna_splits_long_short <- terna %>% \n  left_join(terna_imbalance_volues, by = c(\"qo\" = \"reference_date\")) %>% \n  mutate(imbalance_bin = if_else(imbalance > 0, \"long\", \"short\")) %>% \n  split(.$imbalance_bin)\n\n\n\nTerna\n\nPrices\nFirst I investigate the relationship between realized Picasso prices and imbalance prices for each imbalance sign. In the following plot we look at quarter hours with a positive control area imbalance. Indeed there is a strong link between Picasso prices and imbalance prices in the control area.\n\n\nCode\n# we can see indeed the relationship of volume weighted picasso prices\n# and imbalance prices\n\nterna_splits_long_short$long %>% \n  ggplot(aes(terna_price, terna_vw_price_neg))+\n  geom_point(alpha = 0.3) +\n  theme_bw() +\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (Postive imbalance)\")\n\n\n\n\n\nEven looking at the less extreme values we see a strong correlation between Picasso prices and imbalance prices.\n\n\nCode\nterna_splits_long_short$long %>% \n  filter(terna_price > -100) %>% \n  filter(terna_vw_price_neg > -100) %>% \n  ggplot(aes(terna_price, terna_vw_price_neg))+\n  geom_point(alpha = 0.1) +\n  geom_smooth(method = \"lm\")+\n  theme_bw() +\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (zoomed in)\")\n\n\n\n\n\nThe same strong link is visible filtering for hours with negative control area imbalance.\n\n\nCode\n# the same as above\nterna_splits_long_short$short %>% \n  ggplot(aes(terna_price, terna_vw_price_pos))+\n  geom_point(alpha = 0.3)+\n  theme_bw()+\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (negative imbalance)\")\n\n\n\n\n\n\n\nCode\nterna_splits_long_short$short %>% \n  filter(terna_price < 400 & terna_vw_price_pos < 500) %>% \n  ggplot(aes(terna_price, terna_vw_price_pos))+\n  geom_point(alpha = 0.1)+\n  geom_smooth(method = \"lm\")+\n  theme_bw() +\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (zoomed in)\")\n\n\n\n\n\nThe relationship between volume weighted prices and imbalance prices is more complex in short hours. While there exists a relationship for some quarter hours, in others the imbalance price is completely detached, a Picasso price of 0 leads to a non zero imbalance price in the control area (all the points concentrating on the 0 value of the x axis).\n\n\nVolumes\nWe can observe that the price for secondary reserve on the Picasso platform is highly dependent on the volume requested.\n\n\nCode\nterna_splits_long_short$long %>% \n  ggplot(aes(terna_vw_price_neg, terna_total_neg_called))+\n  geom_point(alpha = 0.4)+\n  theme_bw()+\n  ggtitle(\"Total negative sec. reserve called vs price for sec. reserve\")\n\n\n\n\n\nLet’s zoom in to see the concentration of points in the top right corner.\n\n\nCode\nterna_splits_long_short$long %>%\n  filter(terna_total_neg_called >= -300 & terna_vw_price_neg >= -300) %>% \n  ggplot(aes(terna_vw_price_neg, terna_total_neg_called))+\n  geom_point(alpha = 0.2)+\n  theme_bw()+\n  ggtitle(\"Total negative sec. reserve called vs price for sec. reserve\")\n\n\n\n\n\n\n\nCode\nterna_splits_long_short$short %>% \n  ggplot(aes(terna_vw_price_pos, terna_total_pos_called))+\n  geom_point(alpha = 0.4)+\n  theme_bw()+\n  ggtitle(\"Total positive sec. reserve called vs price for sec. reserve\")\n\n\n\n\n\nThe same strong link between called volumes and prices is true for upwards reserve.\n\n\nCode\nterna_splits_long_short$short %>%\n  filter(terna_vw_price_pos < 1000) %>% \n  filter(terna_total_pos_called < 1000) %>% \n  ggplot(aes(terna_vw_price_pos, terna_total_pos_called))+\n  geom_point(alpha = 0.4)+\n  theme_bw()+\n  ggtitle(\"Total positive sec. reserve called vs price for sec. reserve\")\n\n\n\n\n\nLike in the case of negative aFRR called also in case of calling positive aFRR there is almost a linear relationship between volumes and prices, with the exception of quite some quarter hours, that have a price of 0 while Terna is calling volumes from the Picasso platform.\n\n\nLink to Imbalance prices in the control area NORD Terna\n\n\nCode\nterna_splits_long_short$long %>% \n  select(terna_total_neg_called, terna_price, imbalance, terna_vw_price_neg) %>% \n  GGally::ggpairs(alpha = 0.3)+\n  theme_bw()\n\n\n\n\n\n\n\nCode\nterna_splits_long_short$short %>% \n  select(terna_total_pos_called, terna_price, imbalance, terna_vw_price_pos) %>% \n  GGally::ggpairs(alpha = 0.3)+\n  theme_bw()\n\n\n\n\n\nBoth graphs show the strong link between imbalance prices and volume weighted picasso prices. However, we should keep in mind that it would be challenging working with this predictor, since picasso is not called upon in all quarter hours.\n\n\nCode\nterna_splits_long_short$long %>% \n  mutate(\n    price_published = if_else(is.na(terna_vw_price_neg), 0, 1),\n    volume_published = if_else(is.na(terna_total_neg_called), 0, 1)\n  ) %>% \n  summarise(\n    prices_published = sum(price_published)/n()\n  ) %>% \n  mutate(across(everything(),~round(., 2)))\n\n\n# A tibble: 1 × 1\n  prices_published\n             <dbl>\n1             0.36\n\n\nPrice data is only available for roughly a third of quarter hours - at least in the period subject to this analyiss.\n\n\n\nAPG\n\nPrices\n\n\nCode\n# prepare terna data\n\napg <- picasso_df_aggr %>% select(qo, starts_with(\"apg\"))\n\napg_imbalance_volumes <- arrow::read_parquet(file = \"./data/apg_control_area_imbalance.parquet\") %>% \n  select(df, imbalance = cai)\n\napg_splits_long_short <- apg %>% \n  left_join(apg_imbalance_volumes, by = c(\"qo\" = \"df\")) %>% \n  mutate(imbalance_bin = if_else(imbalance > 0, \"long\", \"short\")) %>% \n  split(.$imbalance_bin)\n\n\n\n\nCode\napg_splits_long_short$long %>% \n  ggplot(aes(apg_price, apg_vw_price_neg))+\n  geom_point(alpha = 0.3) +\n  theme_bw() +\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (Postive imbalance)\")\n\n\n\n\n\n\n\nCode\napg_splits_long_short$long %>% \n  filter(apg_price > -400 & apg_vw_price_neg < 700) %>% \n  ggplot(aes(apg_price, apg_vw_price_neg))+\n  geom_point(alpha = 0.3) +\n  theme_bw() +\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (Postive imbalance)\")\n\n\n\n\n\n\n\nCode\napg_splits_long_short$short %>% \n  ggplot(aes(apg_price, apg_vw_price_pos))+\n  geom_point(alpha = 0.3)+\n  theme_bw()+\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (negative imbalance)\")\n\n\n\n\n\n\n\nCode\napg_splits_long_short$short %>% \n  filter(apg_price < 400 & apg_price > -100) %>% \n  filter(apg_vw_price_pos < 400 & apg_vw_price_pos > 0) %>% \n  ggplot(aes(apg_price, apg_vw_price_pos))+\n  geom_point(alpha = 0.3)+\n  theme_bw()+\n  ggtitle(\"Volume weighted Picasso prices vs Imbalance Prices (negative imbalance)\")\n\n\n\n\n\nOverall the link between imbalance prices and picasso prices/volumes seems to be much much clearer in the case fo Terna. APG doesn’t present a strong and well identifiable link.\n\n\nVolumes\n\n\nCode\napg_splits_long_short$long %>% \n  ggplot(aes(apg_vw_price_neg, apg_total_neg_called))+\n  geom_point(alpha = 0.4)+\n  theme_bw()+\n  ggtitle(\"Total negative sec. reserve called vs price for sec. reserve\")"
  },
  {
    "objectID": "posts/out_of_balance/index.html#exploring-the-volumetric-link-between-apg-and-terna",
    "href": "posts/out_of_balance/index.html#exploring-the-volumetric-link-between-apg-and-terna",
    "title": "Out of balance",
    "section": "Exploring the volumetric link between APG and Terna",
    "text": "Exploring the volumetric link between APG and Terna\nHere we can compare volumes - we detect the accession of Terna to the platfrom and also a pause in their participation.\n\n\nCode\npicasso_vol_data<- picasso_df %>% select(dt, contains(\"vol\")) %>% \n  mutate(across(everything(), ~replace_na(., 0))) %>% \n  transmute(dt = dt, terna_vol = terna_pos_vol + terna_neg_vol, apg_vol = apg_pos_vol + apg_neg_vol) %>% \n  pivot_longer(-dt) %>% \n  drop_na() %>% \n  group_by(name) %>% \n  summarise_by_time(\n    .date_var = dt, .by = \"15 min\", value = mean(value)\n  ) %>% \n  ungroup() \n\npicasso_vol_data %>% \n  timetk::plot_time_series(dt, value, name, .smooth = FALSE, .title = \"Volumes called by each TSO\")\n\n\n\n\n\n\nThere seems to be a somewhat negative relationship between volumes. The two TSOs mirroring their volume calls on PICASSO.\n\n\nCode\npicasso_vol_data %>% \n  pivot_wider(names_from = name, values_from = value) %>% \n  filter(dt >= \"2023-10-25\") %>% \n  ggplot(aes(terna_vol, apg_vol))+\n  geom_point(alpha = 0.3)+\n  theme_bw()+\n  ggtitle(label = \"Volumes since end of October\")\n\n\n\n\n\n\nExample 26th of August 2023\nAn extreme day in terms of imbalance prices in Austria. We see too that volumes do somewhat correlate on this day. In particular there are 3 phases where Terna and APG call upon a similar level of volumes. For some periods there is a clear relationship between volumes and the imbalance price in Austria, however the very high imbalance prices from 8:00 to 8:30 fall out of this pattern.\n\n\nCode\nplot_volumes  <- picasso_df %>% \n  filter(date(qo) == \"2023-08-26\") %>% \n  select(dt, contains(\"vol\")) %>% \n  pivot_longer(-dt) %>% \n  timetk::plot_time_series(\n    dt, value, name, .smooth = FALSE,\n    .title = \"4s granularity - volumes data + imbalance prices /10\",\n    .interactive = FALSE\n  )\n\nimb_price <- picasso_df_aggr %>% \n  select(qo, apg_price) %>% \n  filter(date(qo) == \"2023-08-26\") %>% \n  mutate(apg_price = apg_price/10)\n\nplot_vol_price <- plot_volumes + \n  geom_point(imb_price, mapping = aes(qo, apg_price))\n\nplotly::ggplotly(plot_vol_price)"
  },
  {
    "objectID": "posts/optimisation/index.html",
    "href": "posts/optimisation/index.html",
    "title": "Optimisation",
    "section": "",
    "text": "Code\n\n#| output: false\n\nusing JuMP\nusing DataFrames\nusing CSV\nusing Plots\nusing GLPK\n\n#cd(\"./posts/optimisation\")\n\nprices_df = CSV.read(\"./data/austria_15_min_day_ahead_prices.csv\", DataFrame)\n\n\n2881×2 DataFrame\n  Row │ Column1                    0\n      │ String31                   Float64\n──────┼────────────────────────────────────\n    1 │ 2023-11-01 00:00:00+01:00   104.3\n    2 │ 2023-11-01 00:15:00+01:00    77.55\n    3 │ 2023-11-01 00:30:00+01:00    64.02\n    4 │ 2023-11-01 00:45:00+01:00    59.19\n    5 │ 2023-11-01 01:00:00+01:00    95.0\n    6 │ 2023-11-01 01:15:00+01:00    65.09\n    7 │ 2023-11-01 01:30:00+01:00    58.25\n    8 │ 2023-11-01 01:45:00+01:00    37.72\n  ⋮   │             ⋮                 ⋮\n 2875 │ 2023-11-30 22:30:00+01:00   122.46\n 2876 │ 2023-11-30 22:45:00+01:00   104.99\n 2877 │ 2023-11-30 23:00:00+01:00   159.04\n 2878 │ 2023-11-30 23:15:00+01:00   135.53\n 2879 │ 2023-11-30 23:30:00+01:00   112.43\n 2880 │ 2023-11-30 23:45:00+01:00    85.03\n 2881 │ 2023-12-01 00:00:00+01:00   127.55\n                          2866 rows omitted\n\n\nCode\nprices_df = rename!(prices_df, [:date, :price])\n\n\n2881×2 DataFrame\n  Row │ date                       price\n      │ String31                   Float64\n──────┼────────────────────────────────────\n    1 │ 2023-11-01 00:00:00+01:00   104.3\n    2 │ 2023-11-01 00:15:00+01:00    77.55\n    3 │ 2023-11-01 00:30:00+01:00    64.02\n    4 │ 2023-11-01 00:45:00+01:00    59.19\n    5 │ 2023-11-01 01:00:00+01:00    95.0\n    6 │ 2023-11-01 01:15:00+01:00    65.09\n    7 │ 2023-11-01 01:30:00+01:00    58.25\n    8 │ 2023-11-01 01:45:00+01:00    37.72\n  ⋮   │             ⋮                 ⋮\n 2875 │ 2023-11-30 22:30:00+01:00   122.46\n 2876 │ 2023-11-30 22:45:00+01:00   104.99\n 2877 │ 2023-11-30 23:00:00+01:00   159.04\n 2878 │ 2023-11-30 23:15:00+01:00   135.53\n 2879 │ 2023-11-30 23:30:00+01:00   112.43\n 2880 │ 2023-11-30 23:45:00+01:00    85.03\n 2881 │ 2023-12-01 00:00:00+01:00   127.55\n                          2866 rows omitted\n\n\nCode\n\nprice = prices_df.price\n\n\n2881-element Vector{Float64}:\n 104.3\n  77.55\n  64.02\n  59.19\n  95.0\n  65.09\n  58.25\n  37.72\n  66.3\n  62.24\n   ⋮\n 152.55\n 148.0\n 122.46\n 104.99\n 159.04\n 135.53\n 112.43\n  85.03\n 127.55\n\n\nCode\nmax_charging_power = 20\n\n\n20\n\n\nCode\nmax_discharging_power = 20\n\n\n20\n\n\nCode\nmax_energy_level = 150\n\n\n150\n\n\nCode\ninitial_energy_level = 10  # adjust the initial energy \n\n\n10\n\n\nCode\ncharging_efficiency = 0.95\n\n\n0.95\n\n\nCode\ndischarging_efficiency = 0.95\n\n\n0.95\n\n\nCode\n\nfunction optimise_battery(\n  prices_df,\n  max_charging_power, max_discharging_power, \n  max_energy_level, initial_energy_level, \n  charging_efficiency, discharging_efficiency\n  )\n\nn = length(prices)\nmodel = Model(GLPK.Optimizer)\n\n@variable(model, 0 <= power_charging[i = 1:n] <= max_charging_power)\n@variable(model, 0 <= power_discharging[i = 1:n] <= max_discharging_power)\n@variable(model, 0 <= energy_in_battery[i = 1:n] <= max_energy_level)\n@constraint(model, energy_in_battery[1] == initial_energy_level)\n\nfor i in 1:n\n    @constraint(model, energy_in_battery[i] == sum(power_charging[1:i] * charging_efficiency - power_discharging[1:i] * (1/discharging_efficiency)) + initial_energy_level)\n    @constraint(model, energy_in_battery[i] >= 0)\n    @constraint(model, energy_in_battery[i] <= max_energy_level)\nend\n\n# objective function\n@objective(model, Max, sum(price[i] * (power_discharging[i] - power_charging[i]) for i in 1:n))\n\noptimize!(model)\n\nopt_power_charging = value.(power_charging)\nopt_power_discharging = value.(power_discharging)\nopt_energy_in_battery = value.(energy_in_battery)\n\ninsertcols!(prices_df, 3, :charging => opt_power_charging)\ninsertcols!(prices_df, 4, :discharging => opt_power_discharging)\ninsertcols!(prices_df, 5, :energy_in_battery => opt_energy_in_battery)\n\nreturn prices_df\n\nend\n\n\noptimise_battery (generic function with 1 method)\n\n\n\n\nCode\n\nCSV.write(\"./data/optimisation.csv\", prices_df)\n\n\n\"./data/optimisation.csv\"\n\n\n\n\nCode\nlibrary(tidyverse)\nlibrary(timetk)\n\n#setwd(\"./posts/optimisation/\")\n\ndf <- read_csv(\"./data/optimisation.csv\")\n\ndf %>%\n  pivot_longer(-date) %>%\n  timetk::plot_time_series(\n    date, value, name, .smooth = FALSE, .title = \"Optimisation Result\"\n  )"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "powerpulse",
    "section": "",
    "text": "Out of balance\n\n\n\n\n\n\n\nimbalance\n\n\nanalysis\n\n\n\n\n\n\n\n\n\n\n\nNov 25, 2023\n\n\nJakob Prossliner\n\n\n\n\n\n\n  \n\n\n\n\nOptimisation\n\n\n\n\n\n\n\noptimisation\n\n\n\n\n\n\n\n\n\n\n\nNov 25, 2023\n\n\nJakob Prossliner\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "About this blog"
  }
]